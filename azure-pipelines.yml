# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none
pr: none

name: $(TeamProject)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

variables:
  QUEUE_NAME: "test"
  CONTAINER: "test"
  BLOB_PREFIX: "test/test-"

stages:
- stage: Build
  pool:
    vmImage: 'ubuntu-latest'
  jobs:
  - job: Build
    steps:
    - script: |
        echo "Build"
      displayName: Build script
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
        addToPath: true
        architecture: 'x64'
    - script: |
        pip install azure-storage-queue azure-storage-blob
        pip --version
        pip list
        python --version
      displayName: test
    - task: PythonScript@0
      inputs:
        scriptSource: 'inline'
        script: |
          import time
          from azure.storage.queue import QueueClient, BinaryBase64DecodePolicy
          from azure.storage.blob import BlobServiceClient
          
          blob_service_client = BlobServiceClient.from_connection_string('$(AZURE_STORAGE_CONNECTION_STRING)')
          def write_file(lines, blob_prefix, file_prefix=""):
            local_file_name = file_prefix + time.strftime("_%Y%m%d-%H%M%S-%f") + '.json'
            with open(local_file_name, "w") as file:
              file.writelines(lines)
            blob_file_name = blob_prefix + local_file_name
            blob_client = blob_service_client.get_blob_client(container='$(CONTAINER)', blob=blob_file_name)
            with open(local_file_name, "rb") as data:
              blob_client.upload_blob(data)
          queue_client = QueueClient.from_connection_string('$(AZURE_STORAGE_CONNECTION_STRING)', '$(QUEUE_NAME)')
          queue_client.message_decode_policy = BinaryBase64DecodePolicy()
          messages = queue_client.receive_messages(messages_per_page=20)
          page = 0
          for msg_batch in messages.by_page():
            page = page + 1
            local_file_name = time.strftime("_%Y%m%d-%H%M%S-%f") + '.json'
            build_messages = []
            build_results = []
            msgs = []
            for msg in msg_batch:
              msgs.append(msgs)
              print(msg.content)
              build_messages.append(msg.content)
            write_file(build_messages, '$(BLOB_PREFIX)')
            #for msg in msgs:
            #  queue_client.delete_message(msg)
      env:
        AZURE_STORAGE_CONNECTION_STRING: '$(AZURE_STORAGE_CONNECTION_STRING)'